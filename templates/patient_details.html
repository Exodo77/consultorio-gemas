{% extends 'base.html' %}

{% block title %}Detalles de {{ patient.name }}{% endblock %}

{% block content %}
<h2 class="mb-4">Detalles del Paciente: {{ patient.name }}</h2>

<div class="card mb-4">
    <div class="card-header">
        Información Personal
    </div>
    <div class="card-body">
        <p><strong>Nombre:</strong> {{ patient.name }}</p>
        <p><strong>Fecha de Nacimiento:</strong> {{ patient.dob }}</p>
        <p><strong>Género:</strong> {{ patient.gender }}</p>
        <p><strong>Dirección:</strong> {{ patient.address }}</p>
        <p><strong>Teléfono:</strong> {{ patient.phone }}</p>
        <p><strong>Email:</strong> {{ patient.email }}</p>
        <a href="{{ url_for('edit_patient', patient_id=patient.id) }}" class="btn btn-warning me-2">Editar Paciente</a>
        <form action="{{ url_for('delete_patient', patient_id=patient.id) }}" method="POST" style="display:inline;">
            <button type="button" class="btn btn-danger delete-patient-btn" data-patient-id="{{ patient.id }}" data-patient-name="{{ patient.name }}">Eliminar Paciente</button>
        </form>
    </div>
</div>

<h3 class="mb-3">Historial Clínico</h3>
<a href="{{ url_for('add_medical_record', patient_id=patient.id) }}" class="btn btn-success mb-3">Añadir Nueva Historia Clínica</a>

{% if medical_records %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Motivo</th>
                <th>Diagnóstico</th>
                <th>Tratamiento</th>
                <th>Notas</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for record in medical_records %}
            <tr>
                <td>{{ record.record_date }}</td>
                <td>{{ record.reason }}</td>
                <td>{{ record.diagnosis }}</td>
                <td>{{ record.treatment }}</td>
                <td>{{ record.notes }}</td>
                <td>
                    <a href="{{ url_for('edit_medical_record', record_id=record.id) }}" class="btn btn-warning btn-sm">Editar</a>
                    <form action="{{ url_for('delete_medical_record', record_id=record.id) }}" method="POST" style="display:inline;">
                        <button type="button" class="btn btn-danger btn-sm delete-record-btn" data-record-id="{{ record.id }}" data-record-date="{{ record.record_date }}">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
    <p class="text-center">No hay historias clínicas registradas para este paciente.</p>
{% endif %}

<a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">Volver a la Lista de Pacientes</a>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Para eliminar paciente ---
    const deletePatientButton = document.querySelector('.delete-patient-btn');
    if (deletePatientButton) { // Asegura que el botón exista
        deletePatientButton.addEventListener('click', function() {
            const patientId = this.dataset.patientId;
            const patientName = this.dataset.patientName;
            const form = this.closest('form');

            Swal.fire({
                title: '¿Estás seguro?',
                html: `¿Quieres eliminar a <b>${patientName}</b> y todos sus registros médicos? <br> ¡Esta acción es irreversible!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    }

    // --- Para eliminar historia clínica ---
    const deleteRecordButtons = document.querySelectorAll('.delete-record-btn');
    deleteRecordButtons.forEach(button => {
        button.addEventListener('click', function() {
            const recordId = this.dataset.recordId;
            const recordDate = this.dataset.recordDate;
            const form = this.closest('form');

            Swal.fire({
                title: '¿Estás seguro?',
                html: `¿Quieres eliminar la historia clínica del <b>${recordDate}</b>? <br> ¡Esta acción es irreversible!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });
});
</script>
{% endblock %}